<!DOCTYPE html>
<html>
<head>
    <title>Archimed</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
          integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Rubik:400,900&display=swap&subset=cyrillic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,900&display=swap&subset=cyrillic" rel="stylesheet">
    <link rel="stylesheet" href="/css/leaflet.css"/>
    <link rel="stylesheet" href="/css/style.v.1.1.1.css"/>
    <link rel="stylesheet" href="/css/responsive.css"/>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/leaflet.js"></script>
    <script src="/js/vue.js"></script>
    <script src="/js/main.js"></script>
</head>
<body>
<div id="app">
    <div id="menu-top">
        <!--            <div class="container-flex">-->
        <div class="logo">ARCHIMED</div>
        <div class="right-panel">
            <div class="search menu-item">
                <button>Найти</button>
            </div>
            <div class="link menu-item">
                <div class="splitter"></div>
                <a href="#">Тех.поддержка</a>
            </div>
            <div class="account menu-item">
                <div class="splitter"></div>
                <div class="text">Участок №3</div>
                <div class="img"><img src="/img/avatar.png" alt="Участок №3"></div>
            </div>
        </div>

        <!--            </div>-->
    </div>

    <div id="left-panel">
        <ul class="accordion-menu">
            <li class="open" v-on:click="onClickMap">
                <div class="dropdownlink">
                    <div class="icon icon-map"></div>
                    <div class="text">Карта</div>
                </div>
                <ul class="submenuItems" id="typeMap" style="display: block;">
                    <li v-on:click="onClickTypeMap" class="active"><a class="radiobtn radiobtn1"
                                                                      href="#">Водоснабжение</a></li>
                    <li v-on:click="onClickTypeMap"><a class="radiobtn radiobtn2" href="#">Водоотведение</a></li>
                    <li v-on:click="onClickTypeMap"><a class="radiobtn radiobtn3" href="#">Теплоснабжение</a></li>
                    <li v-on:click="onClickTypeMap"><a class="radiobtn radiobtn4" href="#">Канализация</a></li>
                </ul>
            </li>
            <li>
                <div class="dropdownlink">
                    <div class="icon icon-fragment"></div>
                    <div class="text">Фрагмент</div>
                </div>
                <ul class="submenuItems">
                    <li><a href="#" class="active">Схема</a></li>
                    <li><a href="#" v-on:click="onClickSupport">Информация</a></li>
                    <li><a href="#">История правок</a></li>
                </ul>
            </li>
            <li>
                <div class="dropdownlink">
                    <div class="icon icon-analytica"></div>
                    <div class="text">Аналитика</div>
                </div>
                <ul class="submenuItems">
                    <li><a href="#">Здесь аналитика</a></li>
                </ul>
            </li>
            <div class="btn-support dropdownlink" v-on:click="onClickSupport">
                <div class="icon icon-support"></div>
                <div class="text">Поддержка</div>
            </div>
        </ul>
        <div class="hide-panel" v-on:click="onClickAccordion">
            <img id="strelka" src="img/strelka.svg">
            <span>Свернуть редактор</span>
        </div>
    </div>

    <div id="modal-dialog">
        <p id="modal-dialog-head-text">Все данные об инженерных системах на одной платформе</p>

        <div id="hr-div"></div>

        <p class="modal-dialog-content-text">Что представляет собой ИИС Архимед?</p><br><br><br>
        <p class="modal-dialog-content-text">Для кого предназначена система?</p><br><br><br>
        <p class="modal-dialog-content-text">Какие данные доступны вам в системе?</p><br><br><br>
        <p class="modal-dialog-content-text">Как внести изменения или добавить информацию?

        <div class="btn-close"></div>

        <div id="modal-dialog-content-img">
            <img src="/img/Group_7_6.svg" width="70%">
        </div>

    </div>

    <div id="panel-tools">
        <div v-on:click="onClickCritical" class="btn-critical">Отобразить крические участки</div>
        <div class="btn-add-object">+ Добавить объект</div>
    </div>


    <div id="map"></div>
</div>

<script>
    var map;
    var typeMap = "#61FFF5";

    const app = new Vue({
        el: '#app',
        data: {
            errors: [],
            tubes: [],
            isShowCritical: false,
            type: 0
        },
        mounted: function () {
            map = L.map('map', {
                zoomControl: false
            }).setView([55.038388736512346, 82.91811079370683], 16);

            var osmLayer = new L.TileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a target="_blank" href="http://www.openstreetmap.org">OpenStreetMap.org</a>'
            }).addTo(map);

            this.RefreshObjectsOnMap();

            $(function () {
                var Accordion = function (el, multiple) {
                    this.el = el || {};
                    this.multiple = multiple || false;

                    var dropdownlink = this.el.find('.dropdownlink');
                    dropdownlink.on('click',
                        {el: this.el, multiple: this.multiple}, this.dropdown);
                };

                Accordion.prototype.dropdown = function (e) {
                    var $el = e.data.el,
                        $this = $(this),
                        $next = $this.next();

                    if (!$this.parent().hasClass('open')) {
                        $next.slideToggle();
                        $this.parent().toggleClass('open');
                    }

                    if (!e.data.multiple) {
                        $el.find('.submenuItems').not($next).slideUp().parent().removeClass('open');
                    }
                }

                var accordion = new Accordion($('.accordion-menu'), false);
            });
        },
        methods: {
            onClickAccordion: function (e) {
                var leftPanel = $('#left-panel');
                var strelka = $('#strelka');
                if (leftPanel.css('left') === '-350px') {
                    leftPanel.animate({
                        left: '0'
                    }, 400);
                    strelka.animate({
                            myRotationProperty: 0
                        },
                        {step: function(now, tween) {
                                if (tween.prop === "myRotationProperty") {
                                    $(this).css('-webkit-transform','rotate('+now+'deg)');
                                    $(this).css('-moz-transform','rotate('+now+'deg)');
                                    // add Opera, MS etc. variants
                                    $(this).css('transform','rotate('+now+'deg)');
                                }
                            }
                        });
                }
                else {
                    leftPanel.animate({
                        left: '-350px'
                    }, 400);
                    strelka.animate({
                            myRotationProperty: 180
                        },
                        {step: function(now, tween) {
                                if (tween.prop === "myRotationProperty") {
                                    $(this).css('-webkit-transform','rotate('+now+'deg)');
                                    $(this).css('-moz-transform','rotate('+now+'deg)');
                                    // add Opera, MS etc. variants
                                    $(this).css('transform','rotate('+now+'deg)');
                                }
                            }
                        });
                }
            },
            onClickSupport: function (e) {
                var dialog = $("#modal-dialog");
                var panel = $("#left-panel");
                var body = $("#app");
                var height = body.height() - 185;
                var width = body.width() - panel.width() - 100;

                dialog.width(width);
                dialog.css({left: 400, top: 135, height: height});
                dialog.show();
                e.preventDefault = false;
                map.scrollWheelZoom.disable();
                map.dragging.disable();
                $("#left-panel .btn-support").addClass('active');
            },
            onClickMap: function () {
                $("#modal-dialog").hide();
                map.scrollWheelZoom.enable();
                map.dragging.enable();
                $(".dropdownlink .icon-support").parent().removeClass('active');
            },
            onClickTypeMap: function (e) {
                var childs = $("#typeMap").children();
                var el = e.srcElement;

                Array.from(childs).forEach(function (item) {
                    if (item != el)
                        item.classList.remove("active");
                });

                el.parentElement.classList.add("active");

                if (el.classList.contains("radiobtn1"))
                    this.type = 0;
                else if (el.classList.contains("radiobtn2"))
                    this.type = 1;
                else if (el.classList.contains("radiobtn3"))
                    this.type = 2;
                else if (el.classList.contains("radiobtn4"))
                    this.type = 3;

                this.RefreshObjectsOnMap();
            },
            onClickCritical: function () {
                console.debug(this);

                this.isShowCritical = !this.isShowCritical;

                var btnCritical = $(".btn-critical");

                if (this.isShowCritical) {
                    btnCritical.text("Скрыть критические участки");
                    btnCritical.addClass("showCritical");
                } else {
                    btnCritical.text("Отобразить критические участки");
                    btnCritical.removeClass("showCritical");
                }

                this.RefreshObjectsOnMap();
            },
            RefreshObjectsOnMap: function () {
                var url = '/tube/json?type=' + this.type;
                axios.get(url)
                    .then((response) => {
                    var typeColor;

                if (this.type == 0)
                    typeColor = "#61FFF5";
                else if(this.type == 1)
                    typeColor = "#77FF95";
                else if (this.type == 2)
                    typeColor = "#B7DCFF";
                else if (type == 3)
                    typeColor = "#FECCE4";

                var stoke = {
                    weight: 7,
                    color: typeColor
                };

                var stokeFail = {
                    weight: 7,
                    color: "#f00"
                };

                while (this.tubes.length) {
                    this.tubes.pop();
                }

                var self = this;

                response.data.forEach(function(item){
                    var polyline;

                    if (self.isShowCritical && item.status!=0)
                        polyline = L.polyline( [ [item.startPoint.lat, item.startPoint.lon],[item.endPoint.lat, item.endPoint.lon]], stokeFail).addTo(map);
                    else
                        polyline = L.polyline( [ [item.startPoint.lat, item.startPoint.lon],[item.endPoint.lat, item.endPoint.lon]], stoke).addTo(map);

                    self.tubes.push(polyline);
                });
            })
            .catch(function (error) {
                    console.log(error);
                })
                    .finally(function () {
                    });
            }
        }
    });


</script>
</body>
</html>